<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title or 'Whereami Duel' }}</title>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
    
/* æŒ‡å—é‡çš„è¦–çª—å®¹å™¨ */
#compass-container {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 300px; /* æŒ‡å—é‡å¯è¦‹å¯¬åº¦ */
  height: 40px;
  background-color: rgba(0, 0, 0, 0.6);
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  overflow: hidden; /* éš±è—è¶…å‡ºè¦–çª—çš„æ¨™å°ºéƒ¨åˆ† */
  z-index: 10;
}

/* ä¸­é–“çš„ç´…è‰²æŒ‡é‡ */
#compass-marker {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-top: 10px solid #ff4d4d; /* ç´…è‰²ä¸‰è§’å½¢ */
}

/* åŒ…å«æ‰€æœ‰åˆ»åº¦å’Œæ¨™ç±¤çš„æ¨™å°ºå¸¶ï¼Œå®ƒå°‡æœƒç§»å‹• */
#compass-strip {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  display: flex;
  align-items: center;
  /* è®“ç§»å‹•æ›´å¹³æ»‘ */
}

/* public/css/style.css */

.compass-label {
  color: white;
  font-weight: bold;
  font-size: 1rem;
  position: absolute;
  top: 50%;
  /* è®Šæ›´æ­¤è™•ï¼šä½¿ç”¨ translateX(-50%) ä¾†ç²¾ç¢ºæ°´å¹³ç½®ä¸­ */
  transform: translate(-50%, -50%);
  text-shadow: 0 0 3px black;
}
.compass-tick {
  background-color: white;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
}

.tick-major {
  width: 2px;
  height: 15px;
}

.tick-minor {
  width: 1px;
  height: 10px;
  opacity: 0.7;
}

        /* å…¨å±åœ°å›¾æ ·å¼ */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Lato', sans-serif;
        }

        .fullscreen-game {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #street-view {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            background: #000;
        }

        .results-map-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 1350px;
            height: 650px;
            z-index: 10;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            overflow: hidden;
            border: 3px solid white;
        }

        #results-map {
            width: 100%;
            height: 100%;
        }

        .score-panel {
            position: absolute;
            top: 340px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .score-panel.playing {
            top: 20px;
        }

        .score-panel.left {
            left: 20px;
        }

        .score-panel.right {
            right: 20px;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
            color: #2185d0;
        }

        .player-score {
            font-size: 24px;
            font-weight: bold;
            color: #21ba45;
        }

        .round-info {
            position: absolute;
            bottom: 45px;
            left: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .map-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 10;
            width: 300px;
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            background: white;
            transition: all 0.3s ease;
        }

        .map-container:hover {
            transform: scale(1.05);
        }

        .map-container.hidden {
            display: none;
        }

        #guess-map {
            width: 100%;
            height: 100%;
        }

        .game-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            gap: 15px;
        }

        .control-btn {
            padding: 12px 24px;
            background: rgba(33, 133, 208, 0.9);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(33, 133, 208, 1);
            transform: translateY(-2px);
        }

        .control-btn:disabled {
            background: rgba(158, 158, 158, 0.8);
            cursor: not-allowed;
            transform: none;
        }

        .control-btn.guess-btn {
            background: rgba(33, 186, 69, 0.9);
        }

        .control-btn.guess-btn:hover:not(:disabled) {
            background: rgba(33, 186, 69, 1);
        }

        /* ä¿®å¤ï¼šè®¡æ—¶å™¨ä½ç½®è°ƒæ•´ï¼Œé¿å…ä¸å›åˆä¿¡æ¯é‡å  */
        .timer-display {
            position: absolute;
            top: 70px; /* ä»80pxæ”¹ä¸º70pxï¼Œé¿å…ä¸round-infoé‡å  */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(255, 193, 7, 0.95);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        /* ä¿®å¤ï¼šç­‰å¾…çŠ¶æ€ä½ç½®è°ƒæ•´ */
        .waiting-status {
            position: absolute;
            top: 110px; /* ä»120pxæ”¹ä¸º110px */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(33, 186, 69, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        /* ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .network-status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 100;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .network-status.connected {
            background: rgba(33, 186, 69);
            color: white;
        }

        .network-status.disconnected {
            background: rgba(219, 40, 40);
            color: white;
        }

        .network-status.reconnecting {
            background: rgba(255, 193, 7);
            color: #333;
        }

        /* ä¿®å¤ï¼šå¯¹æ‰‹çŠ¶æ€æŒ‡ç¤ºå™¨ä½ç½®è°ƒæ•´ï¼Œé¿å…é‡å  */
        .opponent-status {
            position: absolute;
            top: 70px !important;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(33, 133, 208, 0.95);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .opponent-status.guessed {
            background: rgba(33, 186, 69, 0.95);
        }

        .waiting-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 15;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .waiting-overlay.hidden {
            display: none;
        }

        .results-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            backdrop-filter: blur(15px);
        }

        .map-legend {
            position: absolute;
            top: 10px !important;
            right: 20px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .legend-color.green { background: #21ba45; }
        .legend-color.blue { background: #2185d0; }
        .legend-color.red { background: #db2828; }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
    		background: rgba(0, 0, 0, 0.8);
            z-index: 25;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .finished-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 25;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .street-view-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .results-map-container {
                width: 90%;
                height: 250px;
                top: 10px;
            }

            .score-panel {
                top: 270px;
                min-width: 150px;
                padding: 10px 15px;
            }

            .score-panel.playing {
                top: 10px;
            }

            .score-panel.left {
                left: 10px;
            }

            .score-panel.right {
                right: 10px;
            }

            .map-container {
                width: 250px;
                height: 150px;
                bottom: 10px;
                right: 10px;
            }

            .timer-display {
                top: 60px !important;
                font-size: 12px;
                padding: 6px 12px;
            }

            .waiting-status {
                top: 100px !important;
                font-size: 12px;
                padding: 6px 12px;
            }

            .game-controls {
                bottom: 10px;
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .map-legend {
                right: 10px;
                top: 270px;
                font-size: 12px;
            }
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 10;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #21ba45, #2185d0);
            transition: width 0.3s ease;
            width: {{ (duel.currentRound / duel.totalRounds * 100) }}%;
        }
    </style>
</head>
<body>
    <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="network-status connected" id="network-status">
        <i class="wifi icon"></i>
        <span id="network-text">Connected</span>
    </div>

    <div class="fullscreen-game">
        {% if duel.status == 'generating' %}
            Generating street view plz wait.

        {% elif duel.status == 'preparing' %}
            <!-- å‡†å¤‡çŠ¶æ€ -->
            <div class="loading-overlay" id="preparing-overlay">
                <div>
                    <div class="ui active centered inline loader"></div>
                    <h2 style="margin-top: 20px;">æ­£åœ¨å‡†å¤‡å¯¹å†³</h2>
                    <p>å¯¹å†³å°†åœ¨ <span id="prep-countdown" style="color: #ff6b6b; font-size: 1.5em;">5</span> ç§’åå¼€å§‹</p>
                    <div style="margin-top: 20px;">
                        <h4>å¦‚æœªè‡ªåŠ¨åŠ è½½è¡—æ™¯è¯·åˆ·æ–°ã€‚</h4>
                    </div>
                </div>
            </div>

        {% elif duel.status == 'playing' %}
            <!-- æ¸¸æˆçŠ¶æ€ - æ˜¾ç¤ºè¡—æ™¯ -->
            
            <!-- è¡—æ™¯è§†å›¾ -->
            <div id="street-view">
                <div class="street-view-loading" id="street-view-loading">
                    <div>
                        <div class="ui active centered inline loader"></div>
                        <h3>æ­£åœ¨åŠ è½½è¡—æ™¯...</h3>
                        <p>å¦‚é•¿æ—¶é—´æœªæ˜¾ç¤ºè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œçŠ¶æ€å¹¶åˆ·æ–°ã€‚</p>
                    </div>
                </div>
            </div>
            <div id="compass-container">
                <div id="compass-strip"></div>
                <div id="compass-marker"></div>
            </div>

            <!-- ç©å®¶å¾—åˆ†é¢æ¿ - å·¦ä¸Šè§’ (æˆ‘çš„å¾—åˆ†) -->
            <div class="score-panel left playing">
                <div class="player-name">
                    <i class="user icon"></i>
                    {{ user.username }}
                    {% if user.userType %}
                        <span class="ui mini label">{{ user.userType }}</span>
                    {% endif %}
                </div>
                <div class="player-score" id="my-score">{{ duel.myScore }}</div>
                <div style="font-size: 12px; color: #666;">Points</div>
            </div>

            <!-- å¯¹æ‰‹å¾—åˆ†é¢æ¿ - å³ä¸Šè§’ -->
            <div class="score-panel right playing">
                <div class="player-name">
                    <i class="user icon"></i>
                    {{ opponent.name }}
                </div>
                <div class="player-score" id="opponent-score">{{ duel.opponentScore }}</div>
                <div style="font-size: 12px; color: #666;">Points</div>
            </div>

            <!-- å›åˆä¿¡æ¯ - é¡¶éƒ¨ä¸­å¤® -->
            <div class="round-info">
                <i class="map marker alternate icon"></i>
                Round {{ duel.currentRound }} of {{ duel.totalRounds }}
            </div>

            <!-- ä¿®å¤ï¼šè®¡æ—¶å™¨æ˜¾ç¤º - 15ç§’å€’è®¡æ—¶ -->
            <div class="timer-display" id="timer-display" style="{% if not duel.firstPickAt %}display: none;{% endif %}">
                <i class="clock icon"></i>
                <span id="timer-text">ä»…å‰© <span id="timer-seconds">15</span>s</span>
            </div>

            <!-- ä¿®å¤ï¼šç­‰å¾…çŠ¶æ€æ˜¾ç¤º - åªåœ¨æˆ‘å·²ç»çŒœæµ‹æ—¶æ˜¾ç¤º -->
            <div class="waiting-status" id="waiting-status" style="{% if not (duel.myGuessLat and duel.myGuessLng) %}display: none;{% endif %}">
                <i class="checkmark icon"></i>
                æ­£åœ¨ç­‰å¾… {{ opponent.name }}...
            </div>

            <!-- ä¿®å¤ï¼šå¯¹æ‰‹çŠ¶æ€æŒ‡ç¤ºå™¨ - åªæ˜¾ç¤ºä¸€ä¸ªå›¾æ ‡ï¼Œé»˜è®¤éšè— -->
            <div class="opponent-status" id="opponent-status" style="display: none;">
                <span id="opponent-status-text">{{ opponent.name }} æ­£åœ¨æ€è€ƒ...</span>
            </div>

            <!-- åœ°å›¾å®¹å™¨ - å³ä¸‹è§’ -->
            <div class="map-container" id="map-container">
                <div id="guess-map"></div>
            </div>

            <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
            <div class="game-controls" id="game-controls" style="{% if duel.myGuessLat and duel.myGuessLng %}display: none;{% endif %}">
                <button class="control-btn" id="toggle-map-btn">
                    <i class="map icon"></i>
                    åˆ‡æ¢åœ°å›¾æ˜¾ç¤º
                </button>
                <button class="control-btn guess-btn" id="guess-btn" disabled>
                    <i class="crosshairs icon"></i>
                    çŒœæµ‹ï¼ˆæˆ–æŒ‰ç©ºæ ¼é”®ï¼‰
                </button>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>

        {% elif duel.status == 'results' %}
            <!-- ç»“æœçŠ¶æ€ - æ˜¾ç¤ºé»‘è‰²èƒŒæ™¯è€Œä¸æ˜¯è¡—æ™¯ -->
			<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #efefef, #efefef); z-index: 1;"></div>
            
            <!-- ç»“æœåœ°å›¾ - é¡¶éƒ¨ä¸­å¤® -->
            <div class="results-map-container">
                <div id="results-map"></div>
            </div>

            <!-- åœ°å›¾å›¾ä¾‹ -->
            <div class="map-legend">
                <h4 style="margin: 0 0 10px 0; color: #333;">å›¾ä¾‹</h4>
                <div class="legend-item">
                    <div class="legend-color green"></div>
                    <span>ç­”æ¡ˆä½ç½®</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color blue"></div>
					<span>{{ user.username }} çš„çŒœæµ‹ä½ç½®</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color red"></div>
                    <span>{{ opponent.name }} çš„çŒœæµ‹ä½ç½®</span>
                </div>
            </div>

            <!-- ç©å®¶å¾—åˆ†é¢æ¿ - åœ°å›¾ä¸‹æ–¹ -->
            <div class="score-panel left">
                <div class="player-name">
                    <i class="user icon"></i>
                    {{ user.username }}
                </div>
                <div class="player-score">{{ duel.myScore + duel.myRoundScore }}</div>
                <div style="font-size: 12px; color: #666;">æ€»åˆ†</div>
                {% if duel.myDistance is not none %}
                <div style="margin-top: 8px;">
                    {% if duel.myDistance == -1 %}
                        <div class="ui small grey label">
                            æœªçŒœæµ‹
                        </div>
                    {% else %}
                        <div class="ui small {% if duel.myDistance < 1 %}green{% elif duel.myDistance < 10 %}yellow{% elif duel.myDistance < 100 %}orange{% else %}red{% endif %} label">
							{% if duel.myDistance < 1 %}
                    			{{ (duel.myDistance * 1000)|round(0) }} m
                			{% else %}
                    			{{ duel.myDistance|round(2) }} km
                			{% endif %}
                        </div>
                    {% endif %}
                    {% if duel.myRoundScore is not none %}
                    <div class="ui small green label">
                        +{{ duel.myRoundScore }} pts
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <div class="score-panel right">
                <div class="player-name">
                    <i class="user icon"></i>
                    {{ opponent.name }}
                </div>
                <div class="player-score">{{ duel.opponentScore + duel.opponentRoundScore }}</div>
                <div style="font-size: 12px; color: #666;">Total Points</div>
                {% if duel.opponentDistance is not none %}
                <div style="margin-top: 8px;">
                    {% if duel.opponentDistance == -1 %}
                        <div class="ui small grey label">
                            æœªçŒœæµ‹
                        </div>
                    {% else %}
                        <div class="ui small {% if duel.opponentDistance < 1 %}green{% elif duel.opponentDistance < 10 %}yellow{% elif duel.opponentDistance < 100 %}orange{% else %}red{% endif %} label">
							{% if duel.opponentDistance < 1 %}
                    			{{ (duel.opponentDistance * 1000)|round(0) }} m
                			{% else %}
                    			{{ duel.opponentDistance|round(2) }} km
                			{% endif %}
                        </div>
                    {% endif %}
                    {% if duel.opponentRoundScore is not none %}
                    <div class="ui small green label">
                        +{{ duel.opponentRoundScore }} pts
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- ç»“æœæ˜¾ç¤ºè¦†ç›–å±‚ - åº•éƒ¨ -->
            <div class="results-overlay">
                <h3 class="ui center aligned header" style="margin: 0 0 15px 0;">
                    <i class="trophy icon"></i>
                    Round {{ duel.currentRound }} Results
                </h3>

                <!-- è½®æ¬¡è·èƒœè€… -->
                {% if duel.myRoundScore is not none and duel.opponentRoundScore is not none %}
                <div class="ui center aligned basic segment" style="margin: 0 0 15px 0; padding: 10px;">
                    {% if duel.myRoundScore > duel.opponentRoundScore %}
                        <div class="ui green label">
                            <i class="trophy icon"></i>
                            ä½ èµ¢äº†è¿™ä¸€è½®ï¼
                        </div>
                    {% elif duel.myRoundScore < duel.opponentRoundScore %}
                        <div class="ui red label">
                            <i class="frown icon"></i>
                            {{ opponent.name }} èµ¢äº†è¿™ä¸€è½®ï¼
                        </div>
                    {% else %}
                        <div class="ui yellow label">
                            <i class="handshake icon"></i>
                            å¹³å±€ï¼
                        </div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="ui center aligned basic segment" style="margin: 0; padding: 10px;">
                    <p style="margin: 0;">
                        {% if duel.currentRound >= duel.totalRounds %}
                            <i class="flag checkered icon"></i>
                            <span id="results-countdown" style="font-weight: bold; color: #db2828;">10</span> ç§’åå°†æ˜¾ç¤ºæœ€ç»ˆç»“æœ...
                        {% else %}
                            <i class="forward icon"></i>
                            ç¬¬ {{ duel.currentRound + 1 }} è½®å°†åœ¨ <span id="results-countdown" style="font-weight: bold; color: #21ba45;">10</span> ç§’åå¼€å§‹...
                        {% endif %}
                    </p>
                </div>
            </div>

        {% elif duel.status == 'finished' %}
            <!-- å®ŒæˆçŠ¶æ€ -->
			<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #efefef, #efefef); z-index: 1;"></div>
            <div class="finished-overlay">
                <div>
                    <h1 class="ui header">
                        <i class="flag checkered icon"></i>
                        å†³æ–—ç»“æŸï¼
                    </h1>

                    {% if duel.myScore > duel.opponentScore %}
                        <div class="ui huge green label">
                            <i class="trophy icon"></i>
                            èƒœåˆ©ï¼
                        </div>
                        <h3 style="color: #21ba45;">ğŸ‰ æ­å–œè·èƒœï¼</h3>
                    {% elif duel.myScore < duel.opponentScore %}
                        <div class="ui huge red label">
                            <i class="frown icon"></i>
                            å¤±è´¥
                        </div>
						<h3 style="color: #db2828;">ğŸ˜” å¾ˆé—æ†¾ï¼Œä½ è¾“äº†ã€‚</h3>
                    {% else %}
                        <div class="ui huge yellow label">
                            <i class="handshake icon"></i>
                            å¹³å±€
                        </div>
						<h3 style="color: #f2711c;">ğŸ¤ è¾¾æˆäº†å¹³å±€ï¼</h3>
                    {% endif %}

                    <div class="ui massive statistic" style="margin: 20px 0;">
                        <div class="value">{{ duel.myScore }} - {{ duel.opponentScore }}</div>
                        <div class="label">æœ€ç»ˆåˆ†æ•°</div>
                    </div>

                    <div style="margin-top: 30px;">
                        <a href="/lobby" class="ui big primary button">
                            <i class="home icon"></i>
                            è¿”å›å¤§å…
                        </a>
                        <a href="/lobby" class="ui big green button">
                            <i class="play icon"></i>
                            å†æ¥ä¸€å±€
                        </a>
                        {% if user.uid %}
                            <a href="/user/{{ user.uid }}" class="ui big secondary button">
                                <i class="user icon"></i>
                                æˆ‘çš„ä¸ªäººèµ„æ–™
                            </a>
                        {% endif %}
						{% if opponent.uid %}
							<a href="/user/{{ opponent.uid }}" class="ui big secondary button">
								<i class="user icon"></i>
								å¯¹æ‰‹çš„ä¸ªäººèµ„æ–™
							</a>
						{% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- JavaScript -->
    <script>
        // Whereami Duel ç³»ç»Ÿå˜é‡
        const duelId = '{{ duel.id }}';
        let currentStatus = '{{ duel.status }}';
        let currentRound = {{ duel.currentRound }};
        const totalRounds = {{ duel.totalRounds }};
        const firstPickAt = {% if duel.firstPickAt %}'{{ duel.firstPickAt }}'{% else %}null{% endif %};
        const resultsStartAt = {% if duel.resultsStartAt %}'{{ duel.resultsStartAt }}'{% else %}null{% endif %};
        const gameStartAt = {% if duel.gameStartAt %}'{{ duel.gameStartAt }}'{% else %}null{% endif %};
        const locations = {{ duel.locations | dump | safe }};
        const googleMapsApiKey = '{{ googleMapsApiKey }}';

        // ç»“æœæ•°æ®
        const resultsData = {
            actualLocation: {% if duel.actualLocation %}{ lat: {{ duel.actualLocation.lat }}, lng: {{ duel.actualLocation.lng }} }{% else %}null{% endif %},
            myGuess: {% if duel.myGuessLat and duel.myGuessLng and duel.myGuessLat != -999 %}{ lat: {{ duel.myGuessLat }}, lng: {{ duel.myGuessLng }} }{% else %}null{% endif %},
            opponentGuess: {% if duel.opponentGuessLat and duel.opponentGuessLng and duel.opponentGuessLat != -999 %}{ lat: {{ duel.opponentGuessLat }}, lng: {{ duel.opponentGuessLng }} }{% else %}null{% endif %}
        };

        // çŠ¶æ€å˜é‡
        let myGuessSubmitted = {{ (duel.myGuessLat and duel.myGuessLng) or 'false' }};
        let opponentGuessSubmitted = {{ (duel.opponentGuessLat and duel.opponentGuessLng) or 'false' }};
        let bothGuessesReceived = myGuessSubmitted && opponentGuessSubmitted;

        // ç”¨æˆ·ä¿¡æ¯
        const currentUser = {
            uid: {{ user.uid }},
            username: '{{ user.username }}'
        };

        // Google Maps å˜é‡
        let panorama, streetViewService, guessMap, guessMarker, resultsMap;
        let isMapVisible = true;
        let mapsApiLoaded = false;

        // Socket.io è¿æ¥ç®¡ç†
        const socket = io({
            transports: ['websocket', 'polling'],
            upgrade: true,
            rememberUpgrade: true,
            timeout: 20000,
            forceNew: false,
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5,
            maxReconnectionAttempts: 10
        });

        // ç½‘ç»œçŠ¶æ€ç®¡ç†
        let isConnected = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;
        let heartbeatInterval = null;
        let lastHeartbeat = Date.now();

        // æ—¶é—´åŒæ­¥
        let serverTimeOffset = 0;
        let timers = {
            preparation: null,
            pickTimeout: null,
            resultsCountdown: null,
            heartbeat: null,
            opponentCheck: null
        };

        console.log('ğŸ® Whereami Duel 15ç§’ç‰ˆæœ¬åŠ è½½');
        console.log(`ğŸ“Š Duel: ${duelId} - Status: ${currentStatus}`);
        console.log(`ğŸ¯ Round: ${currentRound}/${totalRounds}`);
        console.log(`ğŸ“ My guess submitted: ${myGuessSubmitted}, Opponent guess submitted: ${opponentGuessSubmitted}`);
        console.log(`â° First pick at: ${firstPickAt}, Results start at: ${resultsStartAt}`);

        // æ›´æ–°ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨
        function updateNetworkStatus(status, text) {
            const indicator = document.getElementById('network-status');
            const textElement = document.getElementById('network-text');
            
            if (indicator && textElement) {
                indicator.className = `network-status ${status}`;
                textElement.textContent = text;
                
                // æ ¹æ®çŠ¶æ€æ›´æ–°å›¾æ ‡
                const icon = indicator.querySelector('i');
                if (icon) {
                    icon.className = status === 'connected' ? 'wifi icon' : 
                                   status === 'disconnected' ? 'wifi slash icon' : 
                                   'refresh icon spin';
                }
            }
        }

        // ä¿®å¤ï¼šæ›´æ–°å¯¹æ‰‹çŠ¶æ€ï¼Œå»æ‰é‡å¤å›¾æ ‡
        function updateOpponentStatus(hasGuessed) {
            const opponentStatus = document.getElementById('opponent-status');
            const opponentStatusText = document.getElementById('opponent-status-text');
            
            if (opponentStatus && opponentStatusText) {
                if (currentStatus === 'playing' && !myGuessSubmitted) {
                    opponentStatus.style.display = 'block';
                    
                    if (hasGuessed) {
						opponentStatusText.remove();
						opponentStatus.remove();
                    } else {
                        opponentStatus.className = 'opponent-status';
                        opponentStatusText.textContent = '{{ opponent.name }} æ­£åœ¨æ€è€ƒ...';
                    }
                } else {
                    opponentStatus.style.display = 'none';
                }
            }
        }

        // æ·»åŠ ï¼šåœ°å›¾ç‚¹å‡»è®°å½•å‡½æ•°
        function recordMapClick(latLng) {
            if (myGuessSubmitted) {
                return;
            }
            
            // è®°å½•æœ€åä¸€æ¬¡ç‚¹å‡»ä½ç½®åˆ°æœåŠ¡å™¨
            fetch(`/duel/${duelId}/click`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    clickLat: latLng.lat(),
                    clickLng: latLng.lng()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`ğŸ“ Click recorded: ${latLng.lat()}, ${latLng.lng()}`);
                } else {
                    console.error('âŒ Failed to record click:', data.error);
                }
            })
            .catch(error => {
                console.error('âŒ Click recording error:', error);
            });
        }

        // Socket.io äº‹ä»¶å¤„ç†
        socket.on('connect', function() {
            console.log('ğŸ”Œ Connected to Whereami Duel server');
            isConnected = true;
            reconnectAttempts = 0;
            updateNetworkStatus('connected', 'Connected');
            
            // åŠ å…¥å†³æ–—æˆ¿é—´æ—¶ä¼ é€’ç”¨æˆ·ä¿¡æ¯
            socket.emit('join_duel', { 
                duelId: duelId,
                userId: currentUser.uid,
                username: currentUser.username
            });
            
            // å¼€å§‹å¿ƒè·³æ£€æµ‹
            startHeartbeat();
            
            // è¯·æ±‚å½“å‰çŠ¶æ€
            socket.emit('get_duel_status', { duelId: duelId });
        });

        socket.on('duel_joined', function(data) {
            console.log('âœ… Successfully joined duel room:', data.duelId);
        });

        socket.on('error', function(data) {
            console.error('âŒ Socket error:', data.message);
            updateNetworkStatus('disconnected', 'Error: ' + data.message);
        });

        socket.on('disconnect', function(reason) {
            console.log('ğŸ”Œ Disconnected from server:', reason);
            isConnected = false;
            updateNetworkStatus('disconnected', 'Disconnected');
            
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        });

        socket.on('connect_error', function(error) {
            console.error('âŒ Connection error:', error);
            reconnectAttempts++;
            updateNetworkStatus('reconnecting', `Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
            
            if (reconnectAttempts >= maxReconnectAttempts) {
                console.error('âŒ Max reconnection attempts reached');
                updateNetworkStatus('disconnected', 'Connection failed');
            }
        });

        socket.on('reconnect', function(attemptNumber) {
            console.log('ğŸ”„ Reconnected after', attemptNumber, 'attempts');
            isConnected = true;
            reconnectAttempts = 0;
            updateNetworkStatus('connected', 'Reconnected');
            
            // é‡æ–°åŠ å…¥å†³æ–—æˆ¿é—´
            socket.emit('join_duel', { 
                duelId: duelId,
                userId: currentUser.uid,
                username: currentUser.username
            });
            socket.emit('get_duel_status', { duelId: duelId });
        });

        // å¿ƒè·³æ£€æµ‹
        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            
            heartbeatInterval = setInterval(() => {
                if (isConnected) {
                    socket.emit('heartbeat', { 
                        duelId: duelId,
                        timestamp: Date.now() 
                    });
                    lastHeartbeat = Date.now();
                }
            }, 30000); // æ¯30ç§’å‘é€å¿ƒè·³
        }

        socket.on('heartbeat_response', function(data) {
            lastHeartbeat = Date.now();
            console.log('ğŸ’“ Heartbeat response received');
        });

        // å†³æ–—çŠ¶æ€æ›´æ–°å¤„ç†
        socket.on('duel_status_update', function(data) {
            if (data.duelId !== duelId) return;
            
            console.log('ğŸ“Š Duel status update received:', data);
            
            // æ›´æ–°çŠ¶æ€å˜é‡ï¼ˆä½†ä¸ç«‹å³åˆ·æ–°é¡µé¢ï¼‰
            if (data.status) {
                currentStatus = data.status;
            }
            
            // æ›´æ–°çŒœæµ‹çŠ¶æ€
            if (data.player1GuessStatus !== undefined) {
                const isPlayer1 = data.isPlayer1;
                const oldOpponentStatus = opponentGuessSubmitted;
                
                if (isPlayer1) {
                    myGuessSubmitted = data.player1GuessStatus;
                    opponentGuessSubmitted = data.player2GuessStatus;
                } else {
                    myGuessSubmitted = data.player2GuessStatus;
                    opponentGuessSubmitted = data.player1GuessStatus;
                }
                
                bothGuessesReceived = myGuessSubmitted && opponentGuessSubmitted;
                
                console.log(`ğŸ¯ Guess status updated: My=${myGuessSubmitted}, Opponent=${opponentGuessSubmitted}, Both=${bothGuessesReceived}`);
                
                // æ›´æ–°UIæ˜¾ç¤º
                updateOpponentStatus(opponentGuessSubmitted);
                
                // ä¿®å¤ï¼šåŒæ–¹éƒ½é€‰æ‹©åç«‹å³è·³è½¬åˆ°ç»“æœé¡µé¢
                if (bothGuessesReceived && currentStatus === 'playing') {
                    console.log('ğŸŠ Both players have guessed! Transitioning to results...');
                    setTimeout(() => {
                        location.reload();
                    }, 500); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿æœåŠ¡å™¨å¤„ç†å®Œæˆ
                    return;
                }
                
                // å¦‚æœæˆ‘å·²ç»çŒœæµ‹äº†ï¼Œæ˜¾ç¤ºç­‰å¾…çŠ¶æ€
                if (myGuessSubmitted && !bothGuessesReceived) {
                    const waitingStatus = document.getElementById('waiting-status');
                    if (waitingStatus) {
                        waitingStatus.style.display = 'block';
                    }
                    const gameControls = document.getElementById('game-controls');
                    if (gameControls) {
                        gameControls.style.display = 'none';
                    }
                }
            }
        });

        // å†³æ–—æ›´æ–°äº‹ä»¶ï¼ˆè°¨æ…å¤„ç†åˆ·æ–°ï¼‰
        socket.on('duel_updated', function(data) {
            if (data.duelId !== duelId) return;
            
            console.log('ğŸ”„ Duel updated:', data);
            
            switch(data.action) {
                case 'game_started':
                    if (currentStatus === 'preparing') {
                        console.log('ğŸ® Game started - refreshing page');
                        location.reload();
                    }
                    break;
                    
                case 'first_guess':
                    console.log('ğŸ¯ First guess made - updating status only');
                    // ä¸åˆ·æ–°é¡µé¢ï¼Œåªæ›´æ–°çŠ¶æ€ï¼Œæ˜¾ç¤ºè®¡æ—¶å™¨
                    const timerDisplay = document.getElementById('timer-display');
                    if (timerDisplay && !firstPickAt) {
                        timerDisplay.style.display = 'block';
                        startPickTimer();
                    }
                    break;
                    
                case 'both_guessed':
                    console.log('ğŸ“Š Both players guessed - moving to results immediately');
                    location.reload();
                    break;
                    
                case 'timeout':
                    console.log('â° Round timeout - moving to results');
                    if (currentStatus === 'playing') {
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                    break;
                    
                case 'next_round':
                    console.log(`â–¶ï¸ Next round starting: ${data.round}/${totalRounds}`);
                    if (currentStatus === 'results') {
                        location.reload();
                    }
                    break;
                    
                case 'duel_finished':
                    console.log('ğŸ Duel finished');
                    if (currentStatus === 'results') {
                        location.reload();
                    }
                    break;
            }
        });

        // å®šæœŸæ£€æŸ¥å¯¹æ‰‹çŠ¶æ€ï¼ˆé˜²æ­¢é—æ¼æ›´æ–°ï¼‰
        function startOpponentStatusCheck() {
            if (timers.opponentCheck) clearInterval(timers.opponentCheck);
            
            if (currentStatus === 'playing' && !bothGuessesReceived) {
                timers.opponentCheck = setInterval(() => {
                    if (isConnected) {
                        socket.emit('get_duel_status', { duelId: duelId });
                    }
                }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
            }
        }

        // åŒæ­¥æœåŠ¡å™¨æ—¶é—´
        async function syncServerTime() {
            try {
                const response = await fetch('/api/server-time');
                const data = await response.json();
                const networkLatency = 50;
                const serverTime = new Date(data.serverTime).getTime();
                serverTimeOffset = serverTime + networkLatency - Date.now();
                console.log('âœ… æœåŠ¡å™¨æ—¶é—´åŒæ­¥å®Œæˆ');
                return true;
            } catch (error) {
                console.error('âŒ æœåŠ¡å™¨æ—¶é—´åŒæ­¥å¤±è´¥:', error);
                return false;
            }
        }

        function getServerTime() {
            return Date.now() + serverTimeOffset;
        }

        // åˆå§‹åŒ–ç»“æœåœ°å›¾
        function initResultsMap() {
            console.log('ğŸ—ºï¸ åˆå§‹åŒ–ç»“æœåœ°å›¾...');
            
            if (!resultsData.actualLocation) {
                console.error('âŒ æ²¡æœ‰å®é™…ä½ç½®æ•°æ®');
                return;
            }

            const resultsMapElement = document.getElementById('results-map');
            if (!resultsMapElement) {
                console.error('âŒ ç»“æœåœ°å›¾å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            // åˆ›å»ºåœ°å›¾è¾¹ç•Œ
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(resultsData.actualLocation);
            
            if (resultsData.myGuess) bounds.extend(resultsData.myGuess);
            if (resultsData.opponentGuess) bounds.extend(resultsData.opponentGuess);

            // åˆ›å»ºåœ°å›¾
            resultsMap = new google.maps.Map(resultsMapElement, {
                center: bounds.getCenter(),
                zoom: 1,
                mapTypeControl: true,
                streetViewControl: false,
                fullscreenControl: false,
				// æ·»åŠ åœ°å›¾è¾¹ç•Œé™åˆ¶
				restriction: {
					latLngBounds: {
						north: 85,
						south: -85,
						west: -180,
						east: 180
					},
					strictBounds: true // ä¸¥æ ¼é™åˆ¶ï¼Œä¸èƒ½æ‹–æ‹½åˆ°è¾¹ç•Œå¤–
				}
            });

            // è°ƒæ•´åœ°å›¾è§†å›¾ä»¥æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°
            resultsMap.fitBounds(bounds);

            // æ·»åŠ å®é™…ä½ç½®æ ‡è®°ï¼ˆç»¿è‰²ï¼‰
            const actualMarker = new google.maps.Marker({
                position: resultsData.actualLocation,
                map: resultsMap,
                title: 'Correct Answer',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    scaledSize: new google.maps.Size(32, 32)
                },
                zIndex: 1000
            });

            // æ·»åŠ æˆ‘çš„çŒœæµ‹æ ‡è®°ï¼ˆè“è‰²ï¼‰
            if (resultsData.myGuess) {
                const myGuessMarker = new google.maps.Marker({
                    position: resultsData.myGuess,
                    map: resultsMap,
                    title: '{{ user.username }}\'s Guess',
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                        scaledSize: new google.maps.Size(32, 32)
                    },
                    zIndex: 999
                });

                // è¿çº¿ï¼šå®é™…ä½ç½®åˆ°æˆ‘çš„çŒœæµ‹
                new google.maps.Polyline({
                    path: [resultsData.actualLocation, resultsData.myGuess],
                    geodesic: false,
                    strokeColor: '#2185d0',
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    map: resultsMap
                });
            }

            // æ·»åŠ å¯¹æ‰‹çŒœæµ‹æ ‡è®°ï¼ˆçº¢è‰²ï¼‰
            if (resultsData.opponentGuess) {
                const opponentGuessMarker = new google.maps.Marker({
                    position: resultsData.opponentGuess,
                    map: resultsMap,
                    title: '{{ opponent.name }}\'s Guess',
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                        scaledSize: new google.maps.Size(32, 32)
                    },
                    zIndex: 998
                });

                // è¿çº¿ï¼šå®é™…ä½ç½®åˆ°å¯¹æ‰‹çŒœæµ‹
                new google.maps.Polyline({
                    path: [resultsData.actualLocation, resultsData.opponentGuess],
                    geodesic: false,
                    strokeColor: '#db2828',
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    map: resultsMap
                });
            }

            console.log('âœ… ç»“æœåœ°å›¾åˆå§‹åŒ–å®Œæˆ');
        }

        // åˆå§‹åŒ–è¡—æ™¯åœ°å›¾
        function initMap() {
            console.log('ğŸ—ºï¸ åˆå§‹åŒ–è¡—æ™¯åœ°å›¾...');
            
            if (!locations || locations.length === 0) {
                console.log('âŒ æ— ä½ç½®æ•°æ®');
                return;
            }

            const currentLocation = locations[currentRound - 1];
            if (!currentLocation) {
                console.error('âŒ å½“å‰è½®æ¬¡æ— ä½ç½®æ•°æ®:', currentRound);
                return;
            }

            console.log('ğŸ¯ åŠ è½½è¡—æ™¯ä½ç½®:', currentLocation);

            // éšè—åŠ è½½çŠ¶æ€
            const loadingElement = document.getElementById('street-view-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            // åˆå§‹åŒ–è¡—æ™¯æœåŠ¡
            streetViewService = new google.maps.StreetViewService();
            const streetViewElement = document.getElementById('street-view');
            
            if (!streetViewElement) {
                console.error('âŒ è¡—æ™¯å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            // åˆ›å»ºè¡—æ™¯å…¨æ™¯å›¾
            panorama = new google.maps.StreetViewPanorama(streetViewElement, {
                position: { lat: currentLocation.lat, lng: currentLocation.lng },
                draggable: true,
                disableDefaultUI: true,
                showRoadLabels: false,
                linksControl: false,
                clickToGo: true,
                addressControl: false,
                keyboardShortcuts: false,
                scrollwheel: true,
                panControl: true,
                zoomControl: true
            });

            // è¡—æ™¯çŠ¶æ€ç›‘å¬
            panorama.addListener('status_changed', function() {
                const status = panorama.getStatus();
                console.log('ğŸ—ºï¸ è¡—æ™¯çŠ¶æ€:', status);
                
                if (status === 'OK') {
                    console.log('âœ… è¡—æ™¯åŠ è½½æˆåŠŸ');
                } else {
                    console.error('âŒ è¡—æ™¯åŠ è½½å¤±è´¥:', status);
                    streetViewElement.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f44336; color: white;">
                            <div style="text-align: center;">
                                <h3>Street View Loading Failed</h3>
                                <p>Please refresh the page</p>
                                <button onclick="location.reload()" class="ui button" style="margin-top: 10px;">Retry</button>
                            </div>
                        </div>
                    `;
                }
            });

            // åˆå§‹åŒ–çŒœæµ‹åœ°å›¾
            initGuessMap();
            
            console.log('âœ… è¡—æ™¯åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
        }

        // ä¿®æ”¹ï¼šçŒœæµ‹åœ°å›¾ç‚¹å‡»å¤„ç†ï¼Œå¢åŠ ç‚¹å‡»è®°å½•
        function initGuessMap() {
            console.log('ğŸ—ºï¸ åˆå§‹åŒ–çŒœæµ‹åœ°å›¾...');
            
            const guessMapElement = document.getElementById('guess-map');
            if (!guessMapElement) {
                console.error('âŒ çŒœæµ‹åœ°å›¾å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            guessMap = new google.maps.Map(guessMapElement, {
                center: { lat: 0, lng: 0 },
                zoom: 1,
                streetViewControl: false,
                mapTypeControl: false,
                restriction: {
                    latLngBounds: {
                        north: 85.05112878,
                        south: -85.05112878,
                        west: -180,
                        east: 180
                    },
                    strictBounds: true,
                }
            });

            guessMap.addListener('click', (e) => {
                if (myGuessSubmitted) {
                    console.log('âš ï¸ å·²ç»æäº¤çŒœæµ‹ï¼Œå¿½ç•¥åœ°å›¾ç‚¹å‡»');
                    return;
                }
                
                console.log('ğŸ¯ åœ°å›¾ç‚¹å‡»:', e.latLng.lat(), e.latLng.lng());
                
                // è®°å½•ç‚¹å‡»ä½ç½®åˆ°æœåŠ¡å™¨
                recordMapClick(e.latLng);
                
                // æ”¾ç½®æ ‡è®°
                placeGuessMarker(e.latLng);
                
                const guessBtn = document.getElementById('guess-btn');
                if (guessBtn) {
                    guessBtn.disabled = false;
                    guessBtn.style.background = 'rgba(33, 186, 69, 0.9)';
                }
            });
            
            console.log('âœ… çŒœæµ‹åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
            // --- åœ¨é€™è£¡åŠ å…¥ä»¥ä¸‹ä¸‰è¡Œ ---
            setupDynamicCompass(); // å»ºç«‹æŒ‡å—é‡
            updateCompass(0);      // è¨­å®šåˆå§‹ä½ç½®
            panorama.addListener('pov_changed', () => updateCompass(panorama.getPov().heading)); // ç›£è½è¦–è§’è®ŠåŒ–
        }
        function setupDynamicCompass() {
            const strip = document.getElementById('compass-strip');
            if (!strip) return;

            // æ¸…ç©ºèˆŠå…§å®¹ï¼Œä»¥é˜²é‡è¤‡ç”Ÿæˆ
            strip.innerHTML = '';

            const pixelsPerDegree = 4;
            const directions = { 0: 'åŒ—', 45: 'ä¸œåŒ—', 90: 'ä¸œ', 135: 'ä¸œå—', 180: 'å—', 225: 'è¥¿å—', 270: 'è¥¿', 315: 'è¥¿åŒ—' };
            
            for (let i = -360; i < 720; i++) {
                const leftPos = (i * pixelsPerDegree) + (360 * pixelsPerDegree);

                // *** éŒ¯èª¤ä¿®æ­£é» ***
                // ä½¿ç”¨ ((i % 360) + 360) % 360 ç¢ºä¿çµæœæ°¸é æ˜¯æ­£æ•¸ (0-359)
                const key = ((i % 360) + 360) % 360;

                // æª¢æŸ¥ key æ˜¯å¦å­˜åœ¨æ–¼ directions ç‰©ä»¶ä¸­
                if (directions.hasOwnProperty(key)) {
                    const label = document.createElement('span');
                    label.className = 'compass-label';
                    label.textContent = directions[key];
                    label.style.left = `${leftPos}px`;
                    label.style.whiteSpace = "nowrap";
                    // æ¬¡è¦æ–¹å‘å­—é«”ç¸®å°
                    if (key % 90 !== 0) {
                        label.style.fontSize = '0.8rem';
                    }
                    strip.appendChild(label);

                } else if (i % 10 === 0) {
                    // æ¯ 10 åº¦ä¸€å€‹æ¬¡è¦åˆ»åº¦
                    const tick = document.createElement('div');
                    tick.className = 'compass-tick tick-minor';
                    tick.style.left = `${leftPos}px`;
                    strip.appendChild(tick);
                }
            }
        }
        /**
         * æ ¹æ“šè¡—æ™¯çš„æœå‘ (heading) æ›´æ–°æŒ‡å—é‡çš„ä½ç½®
         * @param {number} heading - 0åˆ°360åº¦çš„è§’åº¦å€¼
         */
        function updateCompass(heading) {
            const strip = document.getElementById('compass-strip');
            if (!strip) return;

            const pixelsPerDegree = 4; // å¿…é ˆå’Œ setupDynamicCompass ä¸­çš„å€¼ä¸€è‡´
            const offset = (heading * pixelsPerDegree) - (document.getElementById('compass-container').offsetWidth / 2);
            
            // æˆ‘å€‘ç§»å‹•æ•´å€‹æ¨™å°ºå¸¶ä¾†è®“æ­£ç¢ºçš„æ–¹å‘å°æº–ä¸­é–“çš„æŒ‡é‡
            strip.style.transform = offset > 0 ? `translateX(-${offset}px)` : `translateX(${-offset}px)`;
        }

        // æ”¾ç½®çŒœæµ‹æ ‡è®°
        function placeGuessMarker(latLng) {
            if (guessMarker) {
                guessMarker.setPosition(latLng);
            } else {
                guessMarker = new google.maps.Marker({
                    position: latLng,
                    map: guessMap,
                    title: 'Your guess',
                    animation: google.maps.Animation.DROP
                });
            }
            console.log('ğŸ“ çŒœæµ‹æ ‡è®°å·²æ”¾ç½®:', latLng.lat(), latLng.lng());
        }

        // å¤„ç†çŒœæµ‹æäº¤
        function handleGuess() {
            if (myGuessSubmitted) {
                console.log('âš ï¸ å·²ç»æäº¤è¿‡çŒœæµ‹');
                return;
            }
            
            if (!guessMarker) {
                alert('Please place a marker on the map first!');
                return;
            }

            console.log('ğŸ¯ æäº¤çŒœæµ‹...');
            
            const position = guessMarker.getPosition();
            const guessLat = position.lat();
            const guessLng = position.lng();

            const guessBtn = document.getElementById('guess-btn');
            if (guessBtn) {
                guessBtn.disabled = true;
                guessBtn.innerHTML = '<i class="spinner loading icon"></i> Submitting...';
            }
            
            // ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€
            myGuessSubmitted = true;
            
            fetch(`/duel/${duelId}/guess`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    guessLat: guessLat,
                    guessLng: guessLng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`âœ… çŒœæµ‹æˆåŠŸ: ${guessLat}, ${guessLng}`);
                    
                    // éšè—æ§åˆ¶æŒ‰é’®ï¼Œæ˜¾ç¤ºç­‰å¾…çŠ¶æ€
                    const gameControls = document.getElementById('game-controls');
                    if (gameControls) {
                        gameControls.style.display = 'none';
                    }
                    
                    const waitingStatus = document.getElementById('waiting-status');
                    if (waitingStatus) {
                        waitingStatus.style.display = 'block';
                    }
                    
                    // å¼€å§‹æ£€æŸ¥å¯¹æ‰‹çŠ¶æ€
                    startOpponentStatusCheck();
                    
                } else {
                    console.error('âŒ çŒœæµ‹å¤±è´¥:', data.error);
                    // æ¢å¤çŠ¶æ€
                    myGuessSubmitted = false;
                    if (guessBtn) {
                        guessBtn.disabled = false;
                        guessBtn.innerHTML = '<i class="crosshairs icon"></i> Make Guess';
                    }
                    alert('Failed to submit guess: ' + data.error);
                }
            })
            .catch(error => {
                console.error('âŒ çŒœæµ‹é”™è¯¯:', error);
                // æ¢å¤çŠ¶æ€
                myGuessSubmitted = false;
                if (guessBtn) {
                    guessBtn.disabled = false;
                    guessBtn.innerHTML = '<i class="crosshairs icon"></i> Make Guess';
                }
                alert('Network error. Please try again.');
            });
        }

        // å‡†å¤‡å€’è®¡æ—¶
        function startPreparationCountdown() {
            if (!gameStartAt) return;
            
            const startTime = new Date(gameStartAt).getTime();
            
            timers.preparation = setInterval(() => {
                const serverNow = getServerTime();
                const remaining = Math.max(0, startTime - serverNow);
                const seconds = Math.ceil(remaining / 1000);
                
                const countdownElement = document.getElementById('prep-countdown');
                if (countdownElement) {
                    countdownElement.textContent = seconds;
                }
                
                if (remaining <= 0) {
                    clearInterval(timers.preparation);
                    console.log('ğŸ® æ¸¸æˆå¼€å§‹ - ç­‰å¾…æœåŠ¡å™¨ä¿¡å·');
                }
            }, 100);
        }

        // ä¿®å¤ï¼šæ¸¸æˆè®¡æ—¶å™¨ - 15ç§’å€’è®¡æ—¶
        function startPickTimer() {
            console.log('â° å¼€å§‹æ¸¸æˆè®¡æ—¶å™¨ï¼ˆ15ç§’ï¼‰');
            
            // æ˜¾ç¤ºè®¡æ—¶å™¨
            const timerDisplay = document.getElementById('timer-display');
            if (timerDisplay) {
                timerDisplay.style.display = 'block';
            }
            
            // è®¾ç½®è®¡æ—¶å™¨å¼€å§‹æ—¶é—´
            let startTime;
            if (firstPickAt) {
                startTime = new Date(firstPickAt).getTime();
            } else {
                startTime = Date.now();
            }
            
            const duration = 15000; // ä¿®æ”¹ï¼š15ç§’å€’è®¡æ—¶
            
            if (timers.pickTimeout) clearInterval(timers.pickTimeout);
            
            timers.pickTimeout = setInterval(() => {
                const serverNow = getServerTime();
                const elapsed = serverNow - startTime;
                const remaining = Math.max(0, duration - elapsed);
                const seconds = Math.ceil(remaining / 1000);
                
                const timerElement = document.getElementById('timer-seconds');
                if (timerElement) {
                    timerElement.textContent = seconds;
                }
                
                // ä¿®æ”¹ï¼šæ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤ºæ–‡å­—
                const timerText = document.getElementById('timer-text');
                if (timerText) {
                    timerText.innerHTML = `ä»…å‰© <span id="timer-seconds">${seconds}</span>s`;
                }
                
                console.log(`â° Timer: ${seconds}s remaining`);
                
                if (remaining <= 0) {
                    clearInterval(timers.pickTimeout);
                    console.log('â° æ—¶é—´åˆ°ï¼');
                }
            }, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼Œæ›´æ¸…æ™°
        }

        // ä¿®å¤ï¼šç»“æœå€’è®¡æ—¶ - ç¡®ä¿å€’è®¡æ—¶æ­£ç¡®æ˜¾ç¤º
        function startResultsCountdown() {
            if (!resultsStartAt) return;
            
            console.log('ğŸ“Š å¼€å§‹ç»“æœå€’è®¡æ—¶');
            
            const startTime = new Date(resultsStartAt).getTime();
            const duration = 10000; // 10ç§’
            
            if (timers.resultsCountdown) clearInterval(timers.resultsCountdown);
            
            timers.resultsCountdown = setInterval(() => {
                const serverNow = getServerTime();
                const elapsed = serverNow - startTime;
                const remaining = Math.max(0, duration - elapsed);
                const seconds = Math.ceil(remaining / 1000);
                
                const countdownElement = document.getElementById('results-countdown');
                if (countdownElement) {
                    countdownElement.textContent = seconds;
                }
                
                console.log(`ğŸ“Š Results countdown: ${seconds}s remaining`);
                
                if (remaining <= 0) {
                    clearInterval(timers.resultsCountdown);
                    console.log('ğŸ“Š ç»“æœå€’è®¡æ—¶ç»“æŸ');
                }
            }, 100);
        }

        // Google Maps API å›è°ƒ
        window.initGoogleMapsCallback = function() {
            console.log('âœ… Google Maps API åŠ è½½å®Œæˆ');
            mapsApiLoaded = true;
            
            setTimeout(() => {
                if (currentStatus === 'playing') {
                    initMap();
                } else if (currentStatus === 'results') {
                    initResultsMap();
                }
            }, 100);
        };

        // é”™è¯¯å¤„ç†
        window.handleGoogleMapsError = function() {
            console.error('âŒ Google Maps API åŠ è½½å¤±è´¥');
            const targetElement = document.getElementById(currentStatus === 'results' ? 'results-map' : 'street-view');
            if (targetElement) {
                targetElement.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f44336; color: white;">
                        <div style="text-align: center;">
                            <h3>Google Maps API Loading Failed</h3>
                            <p>Please check your internet connection and refresh the page</p>
                            <button onclick="location.reload()" class="ui button" style="margin-top: 10px;">Retry</button>
                        </div>
                    </div>
                `;
            }
        };

        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeDuelSystem() {
            console.log('ğŸš€ åˆå§‹åŒ– Whereami Duel 15ç§’ç‰ˆæœ¬ç³»ç»Ÿ');
            
            await syncServerTime();
            
            if (currentStatus === 'preparing') {
                startPreparationCountdown();
            } else if (currentStatus === 'playing') {
                // ä¿®å¤ï¼šå¦‚æœæœ‰ firstPickAtï¼Œç«‹å³å¼€å§‹è®¡æ—¶å™¨
                if (firstPickAt) {
                    console.log('â° æ£€æµ‹åˆ°å·²æœ‰ firstPickAtï¼Œå¼€å§‹15ç§’è®¡æ—¶å™¨');
                    startPickTimer();
                }
                updateOpponentStatus(opponentGuessSubmitted);
                startOpponentStatusCheck();
            } else if (currentStatus === 'results') {
                startResultsCountdown();
            }
            
            console.log('âœ… 15ç§’ç‰ˆæœ¬ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }

        // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(document).ready(function() {
            console.log('ğŸ“„ DOM åŠ è½½å®Œæˆ - åˆå§‹åŒ–15ç§’ç‰ˆå†³æ–—ç³»ç»Ÿ');
            
            // åœ°å›¾åˆ‡æ¢æŒ‰é’®
            $('#toggle-map-btn').on('click', function() {
                const mapContainer = document.getElementById('map-container');
                if (mapContainer) {
                    isMapVisible = !isMapVisible;
                    mapContainer.style.display = isMapVisible ? 'block' : 'none';
                    $(this).html(isMapVisible ? 
                        '<i class="eye slash icon"></i> éšè—åœ°å›¾' : 
                        '<i class="eye icon"></i> æ˜¾ç¤ºåœ°å›¾'
                    );
                }
            });

            // çŒœæµ‹æŒ‰é’®
            $('#guess-btn').on('click', handleGuess);
            
            // é”®ç›˜å¿«æ·é”®
            $(document).keydown(function(e) {
                // ç©ºæ ¼é”®æäº¤çŒœæµ‹
                if (e.code === 'Space') {
                    const guessBtn = document.getElementById('guess-btn');
                    if (guessBtn && !guessBtn.disabled && !myGuessSubmitted) {
                        e.preventDefault();
                        handleGuess();
                    }
                }
                // Mé”®åˆ‡æ¢åœ°å›¾
                if (e.which === 77) {
                    const toggleBtn = document.getElementById('toggle-map-btn');
                    if (toggleBtn) {
                        e.preventDefault();
                        toggleBtn.click();
                    }
                }
            });
            
            initializeDuelSystem();
        });

        // åŠ è½½ Google Maps API
        if ((currentStatus === 'playing' || currentStatus === 'results') && googleMapsApiKey) {
            console.log('ğŸ—ºï¸ åŠ è½½ Google Maps API...');
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&callback=initGoogleMapsCallback&libraries=geometry&language=zh-CN`;
            script.async = true;
            script.defer = true;
            script.onerror = window.handleGoogleMapsError;
            document.head.appendChild(script);
        }

        // æ¸…ç†è®¡æ—¶å™¨
        window.addEventListener('beforeunload', function() {
            Object.values(timers).forEach(timer => {
                if (timer) clearInterval(timer);
            });
            
            if (socket) {
                socket.disconnect();
            }
        });

        console.log('âœ… Whereami Duel 15ç§’ç‰ˆæœ¬è„šæœ¬åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
